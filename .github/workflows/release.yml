name: üè∑Ô∏è GitHub Release & Telegram Notify

on:
  workflow_run:
    workflows: ["üöÄ Deploy to Server"]
    types:
      - completed

jobs:
  release:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: üß© Checkout repo
        uses: actions/checkout@v4

      - name: üìù Generate changelog
        run: |
          echo "## üì¶ Changelog - $(date)" > changelog.md
          git log -1 --pretty=format:"%h %s (%an)" >> changelog.md

      - name: üì¢ Notify Telegram
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          NEW_VERSION: v${{ github.run_number }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          RELEASE_URL: https://github.com/${{ github.repository }}/releases/tag/v${{ github.run_number }}
        run: |
          python scripts/notify_telegram.py

      - name: üè∑Ô∏è Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ github.run_number }}
          name: "Release v${{ github.run_number }}"
          body_path: changelog.md
